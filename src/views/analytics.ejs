<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | Report</title>
    <link rel="icon" href="../public/img/favicon.jpg" type="image/png">
    <link rel="stylesheet" type="text/css" href="/css/style4.css">
</head>
<body>
    <div class="navbarr">
        <img class="charusat-logo" src="/images/image-2.png" />
        <div class="Home-nav">
            <a href="/admin-dashboard">
                <img src="../public/img/home.png" alt="Home">
            </a>
        </div>
    </div>
    <h1 align="center">Student Internship Details</h1>
    
    <!-- Search bar -->
    <form action="/search-students" method="get">
        <input type="text" name="query" placeholder="Search Students">
        <button type="submit" class="btn">Search</button>
    </form>
    
    
    <table id="student-table">
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>View</th>
            <th>Status</th>
            <th>Certificate</th>
            <th>Download NOC</th>
        </tr>
        <% internships.forEach((internship) => { %>
            <tr>
                <td><%= internship.student.enrollmentNumber %></td>
                <td><%= internship.student.fullName %></td>
                <td>
                    <a href="/internships?StudentID=<%= student.enrollmentNumber %>">View</a>
                </td>
                <td id="status-<%= student.StudentID %>"><%= student.Status %></td>
                <td>
                    <% if (internship.certificate) { %>
                        <a href="/certification/certificate-preview/<%= student.enrollmentNumber %>" target="_blank">View Certificate</a>
                    <% } else { %>
                        <% if (internship.status === 'APPROVED') { %>
                            Not Uploaded
                        <% } else { %>
                            -
                        <% } %>
                    <% } %>
                </td>
                <td>
                    <% if (internship.status === 'APPROVED') { %>
                        <a href="/capture-pdf/<%= student.enrollmentNumber %>">Download NOC</a>
                    <% } else { %>
                        Not Applicable
                    <% } %>
                </td>
            </tr>
        <% }); %>
    </table>
    
    <script>
        // Define a function to escape special characters in a string to avoid syntax errors
        function ejs_escapeXML(text) {
            if (typeof text !== 'string') return text;
            return text.replace(/[<>"&]/g, function (match) {
                if (match === '<') return '&lt;';
                if (match === '>') return '&gt;';
                if (match === '"') return '&quot;';
                if (match === '&') return '&amp;';
            });
        }

        const internships = <%- JSON.stringify(internships) %>;
        function updateTable(filteredStudents) {
            const studentTable = document.getElementById("student-table");
            

            // Clear the table
            while (studentTable.rows.length > 1) {
                studentTable.deleteRow(1);
            }

            // Update the table with filtered data or all students
            const studentsToDisplay = filteredStudents || students;

            studentsToDisplay.forEach((student) => {
                const row = studentTable.insertRow();
                row.insertCell(0).textContent = student.StudentID;
                row.insertCell(1).textContent = student.StudentName;
                const viewCell = row.insertCell(2);
                const viewLink = document.createElement("a");
                viewLink.textContent = "View";
                viewLink.href = "/viewdetails?StudentID=" + student.StudentID;
                viewCell.appendChild(viewLink);
                const statusCell = row.insertCell(3);
                statusCell.id = "status-" + student.StudentID;
                statusCell.textContent = student.Status;
                const nocCell = row.insertCell(4);
                if (student.Status === 'Approved') {
                    const nocLink = document.createElement("a");
                    nocLink.textContent = "Download NOC";
                    nocLink.href = "/capture-pdf/" + student.StudentID;
                    nocCell.appendChild(nocLink);
                } else {
                    nocCell.textContent = "Not Applicable";
                }
            });

        }

        /
        // Update the event listener to use the correct IDs
        document.getElementById("searchStudentButton").addEventListener("click", searchStudent);

        function searchStudent() {
            // Get the search query from the input field
            const searchQuery = document.getElementById("searchStudentInput").value;
            const filteredStudents = students.filter(student => student.StudentID.includes(searchQuery));
            updateTable(filteredStudents);
        

        const searchQuery = document.getElementById("searchStudentInput").value;
        fetch(`/analytics/search?query=${searchQuery}`)
                .then((response) => response.json())
                .then((data) => {
                    // Update the content of the student table and pagination
                    updateTable(data.students);
                })
                .catch((error) => {
                    console.error("Error searching students:", error);
                });

        }
    </script>
</body>
</html>
